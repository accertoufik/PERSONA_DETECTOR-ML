<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNU Wellness Persona Finder</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for a cleaner look */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .btn-primary {
            width: 100%;
            padding: 0.75rem;
            background-color: #3B82F6;
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563EB;
        }
        /* Spinner styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3B82F6;
            animation: spin 1s ease infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="container mx-auto max-w-6xl">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">SNU Wellness Persona Finder ðŸ“Š</h1>
            <p class="text-lg text-gray-600 mt-2">Discover your lifestyle cluster and get targeted health insights.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Input Form Column -->
            <div class="lg:col-span-1">
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Your Weekly Habits</h2>
                    <form id="persona-form">
                        <div class="space-y-4">
                            <div>
                                <label for="eating_out" class="block text-sm font-medium text-gray-700">Eating Out (times per week)</label>
                                <input type="number" id="eating_out" name="eating_out_per_week" class="form-input mt-1" placeholder="e.g., 3" min="0" required>
                            </div>
                            <div>
                                <label for="food_budget" class="block text-sm font-medium text-gray-700">Food Budget (INR per meal)</label>
                                <input type="number" id="food_budget" name="food_budget_per_meal_inr" class="form-input mt-1" placeholder="e.g., 250" min="0" required>
                            </div>
                            <div>
                                <label for="sweet_tooth" class="block text-sm font-medium text-gray-700">Sweet Tooth Level (1-5)</label>
                                <input type="number" id="sweet_tooth" name="sweet_tooth_level" class="form-input mt-1" placeholder="1 (Low) to 5 (High)" min="1" max="5" required>
                            </div>
                            <div>
                                <label for="hobby_hours" class="block text-sm font-medium text-gray-700">Weekly Hobby Hours</label>
                                <input type="number" id="hobby_hours" name="weekly_hobby_hours" class="form-input mt-1" placeholder="e.g., 8" min="0" required>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary mt-6">Find My Persona</button>
                    </form>
                </div>
            </div>

            <!-- Output/Charts Column -->
            <div class="lg:col-span-2">
                
                <!-- Loading Spinner -->
                <div id="loading" class="text-center p-6" style="display: none;">
                    <div class="spinner"></div>
                    <p class="text-gray-600">Analyzing your persona...</p>
                </div>

                <!-- Error Display -->
                <div id="error-container" class="card p-6" style="display: none;">
                    <h3 class="text-xl font-semibold text-red-600">An Error Occurred</h3>
                    <p id="error-message" class="text-gray-700 mt-2"></p>
                </div>

                <!-- Results -->
                <div id="results" class="space-y-8" style="display: none;">
                    
                    <!-- Persona Description -->
                    <div class="card p-6">
                        <h2 class="text-2xl font-semibold text-blue-600" id="persona-name"></h2>
                        <p class="text-gray-700 mt-2" id="persona-description"></p>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold text-center mb-4">Your Lifestyle vs. Average</h3>
                            <canvas id="radarChart"></canvas>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold text-center mb-4">Cluster Averages</h3>
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart.js global instances
        let radarChart = null;
        let barChart = null;

        // --- API Endpoint ---
        // This MUST match the URL your Flask app (app.py) is running on.
        const API_URL = 'http://127.0.0.1:5000'; 

        // --- Chart Helper Functions ---
        function createRadarChart(labels, userData, avgData) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            // Normalize data for better radar chart visualization
            // We find the max value for each feature across user and avg
            const maxValues = labels.map((_, i) => Math.max(userData[i], avgData[i]));
            const normalizedUser = userData.map((v, i) => (maxValues[i] > 0 ? (v / maxValues[i]) * 100 : 0));
            const normalizedAvg = avgData.map((v, i) => (maxValues[i] > 0 ? (v / maxValues[i]) * 100 : 0));
            
            // Re-label for the chart
            const chartLabels = [
                'Eating Out', 'Food Budget', 'Sweet Tooth', 'Hobby Hours'
            ];

            if (radarChart) {
                radarChart.destroy();
            }
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'Your Habits',
                            data: normalizedUser,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)'
                        },
                        {
                            label: 'SNU Average',
                            data: normalizedAvg,
                            backgroundColor: 'rgba(107, 114, 128, 0.2)',
                            borderColor: 'rgba(107, 114, 128, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(107, 114, 128, 1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            angleLines: { display: true },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                // Show original values on tooltip
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.label === 'Your Habits') {
                                        label += userData[context.dataIndex];
                                    } else {
                                        label += avgData[context.dataIndex].toFixed(1);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createBarChart(labels, personaMap, clusterStats) {
            const ctx = document.getElementById('barChart').getContext('2d');
            
            // Re-label for the chart
            const chartLabels = [
                'Eating Out', 'Food Budget', 'Sweet Tooth', 'Hobby Hours'
            ];
            
            const datasets = clusterStats.map(cluster => {
                const persona = personaMap[cluster.cluster] || { name: `Cluster ${cluster.cluster}` };
                const color = ['rgba(59, 130, 246, 0.6)', 'rgba(239, 68, 68, 0.6)', 'rgba(16, 185, 129, 0.6)'];
                
                return {
                    label: persona.name,
                    data: labels.map(label => cluster[label]),
                    backgroundColor: color[cluster.cluster % color.length],
                };
            });

            if (barChart) {
                barChart.destroy();
            }
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            type: 'logarithmic', // Use log scale due to large budget differences
                            title: {
                                display: true,
                                text: 'Value (Log Scale)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Habit'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y.toFixed(1);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- Fetch Stats for Charts on Page Load ---
        let chartData = null;
        async function fetchChartData() {
            try {
                const response = await fetch(`${API_URL}/get_persona_stats`);
                if (!response.ok) {
                    throw new Error('Could not load chart data.');
                }
                chartData = await response.json();
                
                // Pre-render the bar chart on load
                createBarChart(chartData.labels, chartData.persona_map, chartData.cluster_stats);

            } catch (error) {
                console.error("Error fetching stats:", error);
                // You could show an error in the chart containers
            }
        }
        
        // --- Form Submission Handler ---
        document.getElementById('persona-form').addEventListener('submit', async function(event) {
            event.preventDefault(); // Stop default form submission
            
            // UI elements
            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');

            // Show spinner, hide old results
            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            // 1. Get form data
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            try {
                // 2. Send data to backend
                const response = await fetch(`${API_URL}/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'An unknown error occurred.');
                }
                
                // 3. Display results
                document.getElementById('persona-name').textContent = result.persona.name;
                document.getElementById('persona-description').textContent = result.persona.description;

                // 4. Update charts if data is ready
                if (chartData) {
                    const labels = chartData.labels; // e.g., ['eating_out_per_week', ...]
                    const userData = labels.map(label => result.user_data[label]);
                    const avgData = labels.map(label => chartData.global_avg[label]);

                    createRadarChart(labels, userData, avgData);
                    // Re-create bar chart to ensure it's visible (it might have been created before stats loaded)
                    createBarChart(chartData.labels, chartData.persona_map, chartData.cluster_stats);
                }
                
                // Show results, hide spinner
                loadingDiv.style.display = 'none';
                resultsDiv.style.display = 'block';

            } catch (error) {
                // Show error
                console.error("Error:", error);
                errorMessage.textContent = error.message;
                errorDiv.style.display = 'block';
                loadingDiv.style.display = 'none';
            }
        });
        
        // --- Initial Load ---
        // Fetch the chart data as soon as the page loads
        document.addEventListener('DOMContentLoaded', fetchChartData);

    </script>
</body>
</html>